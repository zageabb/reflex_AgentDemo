{% extends "base.html" %}

{% block title %}Scenario Library · Reflex Agents Factory{% endblock %}

{% block sidebar %}
  {% include "layout/_sidebar.html" %}
{% endblock %}

{% block content %}
  <section class="d-flex flex-column gap-4" id="agents-factory" data-accent="indigo">
    <header class="d-flex flex-wrap justify-content-between align-items-start gap-3">
      <div>
        <h1 class="h3 mb-1" id="active-scenario-title">Select a scenario to begin</h1>
        <div class="d-flex flex-wrap gap-3 align-items-center text-muted small" id="active-scenario-meta">
          <span class="d-inline-flex align-items-center gap-2" data-role="accent-pill">
            <i class="fa-solid fa-folder-tree"></i>
            <span id="active-scenario-category">No category</span>
          </span>
          <span class="d-inline-flex align-items-center gap-2" data-role="accent-pill">
            <i class="fa-solid fa-file-code"></i>
            <span id="active-scenario-filename">—</span>
          </span>
          <span class="d-inline-flex align-items-center gap-2" data-role="accent-pill">
            <i class="fa-solid fa-tags"></i>
            <span id="active-scenario-tags">Add tags to improve discovery</span>
          </span>
        </div>
      </div>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <button class="btn btn-outline-secondary btn-sm" type="button" data-action="restart-scenario">
          <i class="fa-solid fa-arrow-rotate-left me-1"></i>Restart
        </button>
        <button class="btn btn-outline-primary btn-sm" type="button" data-action="copy-transcript">
          <i class="fa-regular fa-copy me-1"></i>Copy transcript
        </button>
      </div>
    </header>

    <div class="chat-surface d-flex flex-column gap-3">
      <div
        class="chat-transcript flex-grow-1 px-4 py-4 border rounded-4 bg-body shadow-sm"
        id="chat-transcript"
        aria-live="polite"
        data-empty="true"
      >
        {% set conversation = conversation | default([]) %}
        {% if conversation %}
          {% for message in conversation %}
            {% include "layout/_chat_message.html" %}
          {% endfor %}
        {% else %}
          <div class="text-center text-muted py-5" id="chat-empty-state">
            <i class="fa-solid fa-robot display-4 mb-3 text-primary"></i>
            <p class="lead mb-1">Choose a scenario from the left panel to preview the scripted conversation.</p>
            <p class="small text-secondary mb-0">Messages will appear here as the scenario plays through each step.</p>
          </div>
        {% endif %}
      </div>

      <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
        <div class="d-flex align-items-center gap-2">
          <button class="btn btn-outline-secondary btn-sm" type="button" data-action="restart-scenario">
            <i class="fa-solid fa-power-off me-1"></i>Restart playback
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" data-action="copy-transcript">
            <i class="fa-regular fa-clipboard me-1"></i>Copy to clipboard
          </button>
        </div>
      </div>
    </div>

    <div class="card shadow-sm" id="chat-input-card">
      <div class="card-body d-flex flex-column gap-3">
        <div class="d-flex align-items-center gap-2">
          <i class="fa-regular fa-keyboard text-primary"></i>
          <h2 class="h6 mb-0">Compose a message</h2>
        </div>
        <form
          class="input-group input-group-sm w-100"
          id="chat-input-form"
          autocomplete="off"
        >
          <label class="visually-hidden" for="chat-user-input">Type a message to add it to the chat transcript</label>
          <span class="input-group-text bg-body-secondary border-0">
            <i class="fa-regular fa-message"></i>
          </span>
          <input
            class="form-control border-0"
            type="text"
            placeholder="Send a message to the agent"
            id="chat-user-input"
            name="message"
            maxlength="2000"
            required
            aria-label="Message to send to the agent"
          />
          <button class="btn btn-primary" type="submit" id="chat-send-button" disabled>
            Send
          </button>
        </form>
        <p class="text-muted small mb-0" id="chat-helper-text">
          Conversations are scripted to highlight Reflex capabilities. Use the restart button to replay a scenario or copy the transcript for documentation.
        </p>
      </div>
    </div>
    <div class="visually-hidden" id="chat-feedback" role="status" aria-live="polite"></div>
  </section>
{% endblock %}

{% block scripts_extra %}
  {{ super() }}
  <script>
    window.AGENT_CONFIG = {
      scenarios: {{ scenarios | tojson }},
      selectedScenarioId: {{ selected_scenario_id | tojson }},
      endpoints: {
        scenarioDetail: "{{ url_for('main.scenario_details', scenario_id='__SCENARIO_ID__') }}",
        snippet: "{{ url_for('main.serve_snippet', snippet_path='__SNIPPET__') }}",
      },
    };
  </script>
  <script src="{{ url_for('static', filename='js/chat.js') }}" defer></script>
{% endblock %}
