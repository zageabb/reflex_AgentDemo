{% extends "base.html" %}

{% block title %}Scenario Library Â· Reflex Demo{% endblock %}

{% block content %}
<div class="container pb-5">
  <div class="row mb-4">
    <div class="col-lg-8">
      <h1 class="mb-2">Scenario Library</h1>
      <p class="text-muted mb-0">
        Browse the available demo scenarios or use the search bar to quickly find a
        specific one. Selecting a scenario will start playback automatically on the
        client.
      </p>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-md-6 col-lg-4">
      <label class="form-label" for="scenario-search">Search scenarios</label>
      <input
        class="form-control"
        id="scenario-search"
        name="search"
        placeholder="Search by title, description, or tag"
        type="search"
        value="{{ search_term }}"
      />
    </div>
  </div>

  <div id="scenario-groups">
    {% if scenario_groups %}
      {% for category, items in scenario_groups.items() %}
        <section class="mb-5" data-category="{{ category }}">
          <h2 class="h4 mb-3">{{ category }}</h2>
          <div class="list-group">
            {% for scenario in items %}
              <a
                class="list-group-item list-group-item-action"
                data-scenario-id="{{ scenario.id }}"
                href="{{ url_for('main.index') }}?scenario={{ scenario.id }}"
              >
                <div class="d-flex justify-content-between align-items-start">
                  <h3 class="h5 mb-1">{{ scenario.title }}</h3>
                </div>
                {% if scenario.description %}
                  <p class="mb-1 text-muted">{{ scenario.description }}</p>
                {% endif %}
                {% if scenario.tags %}
                  <small class="text-secondary">Tags: {{ scenario.tags | join(', ') }}</small>
                {% endif %}
              </a>
            {% endfor %}
          </div>
        </section>
      {% endfor %}
    {% else %}
      <p class="text-muted">No scenarios have been added yet.</p>
    {% endif %}
  </div>
  <p class="text-muted d-none" id="scenario-no-results">No scenarios match your search.</p>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    const SCENARIO_DATA = {{ scenarios | tojson }};
    const SELECTED_SCENARIO = {{ selected_scenario_id | tojson }};

    (function () {
      const searchInput = document.getElementById("scenario-search");
      const groupsContainer = document.getElementById("scenario-groups");
      const emptyState = document.getElementById("scenario-no-results");

      if (!searchInput || !groupsContainer) {
        return;
      }

      const scenarioLookup = new Map(
        SCENARIO_DATA.map((item) => [String(item.id), item])
      );

      function updateSearch(term) {
        const normalized = term.trim().toLowerCase();
        let visibleCount = 0;

        groupsContainer
          .querySelectorAll("section[data-category]")
          .forEach((section) => {
            const items = section.querySelectorAll("[data-scenario-id]");
            let sectionVisible = 0;

            items.forEach((element) => {
              const item = scenarioLookup.get(element.dataset.scenarioId);
              if (!item) {
                element.classList.add("d-none");
                return;
              }

              const haystack = [
                item.title,
                item.description || "",
                Array.isArray(item.tags) ? item.tags.join(" ") : "",
              ]
                .join(" ")
                .toLowerCase();

              if (!normalized || haystack.includes(normalized)) {
                element.classList.remove("d-none");
                sectionVisible += 1;
                visibleCount += 1;
              } else {
                element.classList.add("d-none");
              }
            });

            section.classList.toggle("d-none", sectionVisible === 0);
          });

        const hasResults = normalized === "" || visibleCount > 0;
        if (emptyState) {
          emptyState.classList.toggle("d-none", hasResults);
        }
      }

      searchInput.addEventListener("input", (event) => {
        updateSearch(event.target.value);
      });

      if (searchInput.value) {
        updateSearch(searchInput.value);
      }

      if (SELECTED_SCENARIO) {
        const active = groupsContainer.querySelector(
          `[data-scenario-id="${CSS.escape(String(SELECTED_SCENARIO))}"]`
        );
        if (active) {
          active.classList.add("active");
          active.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      }
    })();
  </script>
{% endblock %}
