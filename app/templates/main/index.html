{% extends "base.html" %}

{% block title %}Scenario Library · Reflex Agents Factory{% endblock %}

{% block sidebar %}
  {% include "layout/_sidebar.html" %}
{% endblock %}

{% block content %}
  <section class="d-flex flex-column h-100" id="agents-factory">
    <div class="card border-0 shadow-sm flex-grow-1">
      <div class="card-header bg-body d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div>
          <p class="text-uppercase text-muted small fw-semibold mb-1">Active scenario</p>
          <h1 class="h3 mb-0" id="active-scenario-title">Select a scenario to begin</h1>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <button class="btn btn-outline-secondary btn-sm" type="button" data-action="restart-scenario">
            <i class="fa-solid fa-arrow-rotate-left me-1"></i>Restart
          </button>
          <button class="btn btn-outline-primary btn-sm" type="button" data-action="copy-transcript">
            <i class="fa-regular fa-copy me-1"></i>Copy transcript
          </button>
        </div>
      </div>
      <div class="card-body p-0 d-flex flex-column">
        <div class="px-4 pt-4 pb-3 border-bottom">
          <div class="d-flex flex-wrap gap-3 align-items-center text-muted small" id="active-scenario-meta">
            <span class="d-inline-flex align-items-center gap-2">
              <i class="fa-solid fa-folder-tree text-primary"></i>
              <span id="active-scenario-category">No category</span>
            </span>
            <span class="d-inline-flex align-items-center gap-2">
              <i class="fa-solid fa-file-code text-primary"></i>
              <span id="active-scenario-filename">—</span>
            </span>
            <span class="d-inline-flex align-items-center gap-2">
              <i class="fa-solid fa-tags text-primary"></i>
              <span id="active-scenario-tags">Add tags to improve discovery</span>
            </span>
          </div>
        </div>
        <div class="chat-transcript flex-grow-1 px-4 py-4" id="chat-transcript" aria-live="polite">
          {% set conversation = conversation | default([]) %}
          {% if conversation %}
            {% for message in conversation %}
              {% include "layout/_chat_message.html" %}
            {% endfor %}
          {% else %}
            <div class="text-center text-muted py-5" id="chat-empty-state">
              <i class="fa-solid fa-robot display-4 mb-3 text-primary"></i>
              <p class="lead mb-1">Choose a scenario from the left panel to preview the scripted conversation.</p>
              <p class="small text-secondary mb-0">Messages will appear here as the scenario plays through each step.</p>
            </div>
          {% endif %}
        </div>
        <div class="card-footer bg-body">
          <div class="d-flex flex-wrap gap-3 align-items-center justify-content-between">
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-outline-secondary btn-sm" type="button" data-action="restart-scenario">
                <i class="fa-solid fa-power-off me-1"></i>Restart playback
              </button>
              <button class="btn btn-outline-primary btn-sm" type="button" data-action="copy-transcript">
                <i class="fa-regular fa-clipboard me-1"></i>Copy to clipboard
              </button>
            </div>
            <div class="input-group input-group-sm w-auto flex-grow-1 flex-lg-grow-0" role="presentation">
              <span class="input-group-text bg-body-secondary border-0">
                <i class="fa-regular fa-message"></i>
              </span>
              <input
                class="form-control border-0"
                type="text"
                placeholder="Live input disabled in this demo"
                aria-label="Demo input disabled"
                disabled
              />
              <button class="btn btn-outline-secondary" type="button" disabled>Send</button>
            </div>
          </div>
          <p class="text-muted small mb-0 mt-3" id="chat-helper-text">
            Conversations are scripted to highlight Reflex capabilities. Use the restart button to replay a scenario or copy the transcript for documentation.
          </p>
          <div class="visually-hidden" id="chat-feedback" role="status" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <section class="mt-4" id="help-center">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <h2 class="h4 mb-3">Need a hand?</h2>
          <p class="text-muted mb-2">
            Each scenario demonstrates a tailored conversation flow. Duplicate an existing scenario from the admin dashboard to use as a starting point, or create a new one to tell a different story.
          </p>
          <ul class="mb-0 text-muted small">
            <li>Select a scenario card to load its metadata and start the scripted chat.</li>
            <li>Use the search box or category filters in the sidebar to quickly narrow down the list.</li>
            <li>Leverage the copy button to share transcripts with your team or drop them into docs.</li>
          </ul>
        </div>
      </div>
    </section>
  </section>
{% endblock %}

{% block scripts_extra %}
  {{ super() }}
  <script>
    const SCENARIO_DATA = {{ scenarios | tojson }};
    const SELECTED_SCENARIO = {{ selected_scenario_id | tojson }};

    (function () {
      const searchInput = document.getElementById("scenario-search");
      const categoryTabs = document.querySelectorAll("[data-category-tab]");
      const scenarioCards = Array.from(document.querySelectorAll("[data-scenario-card]"));
      const scenarioGroups = document.getElementById("scenario-groups");
      const emptyState = document.getElementById("scenario-no-results");
      const activeTitle = document.getElementById("active-scenario-title");
      const activeCategory = document.getElementById("active-scenario-category");
      const activeFilename = document.getElementById("active-scenario-filename");
      const activeTags = document.getElementById("active-scenario-tags");
      const chatFeedback = document.getElementById("chat-feedback");
      const copyButtons = document.querySelectorAll('[data-action="copy-transcript"]');
      const restartButtons = document.querySelectorAll('[data-action="restart-scenario"]');
      const chatTranscript = document.getElementById("chat-transcript");

      if (!scenarioGroups) {
        return;
      }

      const scenarioLookup = new Map(
        SCENARIO_DATA.map((item) => [String(item.id), item])
      );

      let activeCategoryFilter = "__all__";

      function setFeedback(message) {
        if (!chatFeedback) {
          return;
        }
        chatFeedback.textContent = "";
        if (message) {
          void chatFeedback.offsetHeight;
          chatFeedback.textContent = message;
        }
      }

      function applyFilters() {
        const term = (searchInput?.value || "").trim().toLowerCase();
        let visibleCount = 0;

        scenarioGroups
          .querySelectorAll("[data-category-panel]")
          .forEach((section) => {
            let sectionVisible = 0;
            section.querySelectorAll("[data-scenario-card]").forEach((card) => {
              const cardCategory = card.dataset.scenarioCategory;
              const searchText = card.dataset.searchText || "";
              const matchesCategory =
                activeCategoryFilter === "__all__" || cardCategory === activeCategoryFilter;
              const matchesSearch = !term || searchText.includes(term);

              if (matchesCategory && matchesSearch) {
                card.classList.remove("d-none");
                visibleCount += 1;
                sectionVisible += 1;
              } else {
                card.classList.add("d-none");
              }
            });

            section.classList.toggle("d-none", sectionVisible === 0);
          });

        if (emptyState) {
          emptyState.classList.toggle("d-none", visibleCount > 0);
        }
      }

      function setActiveScenario(id) {
        const activeId = String(id || "");
        scenarioCards.forEach((card) => {
          const isActive = card.dataset.scenarioId === activeId;
          card.classList.toggle("active", isActive);
          card.setAttribute("aria-current", isActive ? "true" : "false");
        });

        const data = scenarioLookup.get(activeId);
        if (!data) {
          if (activeTitle) {
            activeTitle.textContent = "Select a scenario to begin";
          }
          if (activeCategory) {
            activeCategory.textContent = "No category";
          }
          if (activeFilename) {
            activeFilename.textContent = "—";
          }
          if (activeTags) {
            activeTags.textContent = "Add tags to improve discovery";
          }
          return;
        }

        if (activeTitle) {
          activeTitle.textContent = data.title || data.id;
        }
        if (activeCategory) {
          activeCategory.textContent = data.category || "Uncategorized";
        }
        if (activeFilename) {
          activeFilename.textContent = data.filename || `${data.id}.json`;
        }
        if (activeTags) {
          if (Array.isArray(data.tags) && data.tags.length > 0) {
            activeTags.textContent = data.tags.join(", ");
          } else {
            activeTags.textContent = "No tags provided";
          }
        }

        document.dispatchEvent(
          new CustomEvent("scenario:selected", {
            detail: { scenario: data },
          })
        );
      }

      categoryTabs.forEach((tab) => {
        tab.addEventListener("click", () => {
          categoryTabs.forEach((item) => item.classList.remove("active"));
          tab.classList.add("active");
          activeCategoryFilter = tab.dataset.categoryTab || "__all__";
          applyFilters();
        });
      });

      if (searchInput) {
        searchInput.addEventListener("input", () => {
          applyFilters();
        });
      }

      scenarioCards.forEach((card) => {
        card.addEventListener("click", (event) => {
          const scenarioId = card.dataset.scenarioId;
          if (!scenarioId) {
            return;
          }
          if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey || event.button !== 0) {
            return;
          }
          event.preventDefault();
          setActiveScenario(scenarioId);
          const url = new URL(window.location.href);
          url.searchParams.set("scenario", scenarioId);
          window.history.replaceState({}, "", url);
        });
      });

      copyButtons.forEach((button) => {
        button.addEventListener("click", async () => {
          if (!chatTranscript) {
            return;
          }
          const text = chatTranscript.innerText.trim();
          if (!text) {
            setFeedback("There is no transcript to copy yet.");
            return;
          }
          try {
            await navigator.clipboard.writeText(text);
            setFeedback("Transcript copied to your clipboard.");
          } catch (error) {
            console.error("Clipboard copy failed", error);
            setFeedback("Unable to copy transcript. Try using Ctrl+C instead.");
          }
        });
      });

      restartButtons.forEach((button) => {
        button.addEventListener("click", () => {
          document.dispatchEvent(new CustomEvent("scenario:restart"));
          setFeedback("Scenario reset. Ready to play again.");
        });
      });

      if (SELECTED_SCENARIO) {
        setActiveScenario(SELECTED_SCENARIO);
      } else if (scenarioCards.length) {
        setActiveScenario(scenarioCards[0].dataset.scenarioId);
      }

      applyFilters();
    })();
  </script>
{% endblock %}
