{% extends "base.html" %}

{% block title %}Edit Scenario {{ scenario_id }} · Reflex Agents Factory{% endblock %}

{% block sidebar %}
  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <h2 class="h5 mb-3">Schema reference</h2>
      <p class="text-muted small mb-3">
        Scenarios are JSON documents that describe a scripted conversation. Every file should include an identifier, metadata block, and an ordered list of steps.
      </p>
      <pre class="bg-body-tertiary border rounded p-3 small mb-3"><code>{
  "id": "unique-id",
  "metadata": {
    "title": "Display name",
    "description": "Optional summary shown in the UI",
    "category": "Grouping label",
    "tags": ["ai", "sales"]
  },
  "steps": [
    {
      "actor": "assistant",
      "message": "What the agent says",
      "snippet": "optional-snippet.html"
    }
  ]
}</code></pre>
      <ul class="text-muted small ps-3 mb-0">
        <li class="mb-2">Keep identifiers URL-safe—lowercase letters, numbers, and dashes work best.</li>
        <li class="mb-2">Reference uploads via the <code>snippet</code> key; the file must exist under uploads or data snippets.</li>
        <li>Store any extra metadata inside <code>metadata.extras</code> to avoid breaking the player.</li>
      </ul>
    </div>
  </div>
{% endblock %}

{% block content %}
  <div class="d-flex flex-wrap justify-content-between align-items-start gap-3 mb-4">
    <div>
      <p class="text-uppercase text-muted small fw-semibold mb-1">Scenario editor</p>
      <h1 class="h3 mb-1">Editing {{ scenario_name }}</h1>
      <p class="text-muted mb-0">Use the Ace editor to update the JSON payload. Formatting and validation helpers are provided.</p>
    </div>
    <a class="btn btn-outline-secondary" href="{{ url_for('admin.scenarios') }}">
      <i class="fa-solid fa-arrow-left me-1"></i>Back to library
    </a>
  </div>

  <form method="post" novalidate id="scenario-editor-form" class="card border-0 shadow-sm">
    {{ form.hidden_tag() }}
    <div class="card-body">
      <div class="mb-3">
        <label class="form-label" for="scenario-editor">Scenario JSON</label>
        <div id="scenario-editor" class="border rounded" style="min-height: 520px">{{ form.content.data | e }}</div>
        {{ form.content(class="d-none", id="scenario-editor-input") }}
        {% for error in form.content.errors %}
          <div class="text-danger small">{{ error }}</div>
        {% endfor %}
        <div class="form-text">Valid JSON with an <code>id</code>, <code>metadata</code>, and <code>steps</code> array is required.</div>
      </div>
    </div>
    <div class="card-footer d-flex flex-wrap gap-2 justify-content-between align-items-center">
      <div class="btn-group" role="group" aria-label="Editor helpers">
        <button class="btn btn-outline-secondary" type="button" id="format-json">
          <i class="fa-solid fa-wand-magic-sparkles me-1"></i>Format JSON
        </button>
        <button class="btn btn-outline-secondary" type="button" id="validate-json">
          <i class="fa-solid fa-check-double me-1"></i>Validate JSON
        </button>
      </div>
      {{ form.submit(class="btn btn-primary") }}
    </div>
  </form>
  <div class="mt-3" id="editor-feedback" role="status" aria-live="polite"></div>
{% endblock %}

{% block scripts_extra %}
  {{ super() }}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js" integrity="sha512-TMumqEd2fBF41oA3zQRe65fx2Yol91ux6qdcNccIelG0+D7u3OO8CHW80vA56Zk8Hn1O5cH+3cMyRgDrWCOTaQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    (function () {
      const textarea = document.getElementById("scenario-editor-input");
      const form = document.getElementById("scenario-editor-form");
      const feedback = document.getElementById("editor-feedback");
      const editorElement = document.getElementById("scenario-editor");

      if (!textarea || !form || !editorElement) {
        return;
      }

      const editor = ace.edit(editorElement, {
        mode: "ace/mode/json",
        theme: "ace/theme/textmate",
        wrap: true,
        useWorker: true,
        minLines: 20,
        maxLines: Infinity,
      });
      editor.session.setValue(textarea.value);

      function setFeedback(message, level) {
        if (!feedback) {
          return;
        }
        feedback.textContent = message;
        feedback.className = level ? `alert alert-${level}` : "";
      }

      document.getElementById("format-json")?.addEventListener("click", () => {
        try {
          const parsed = JSON.parse(editor.getValue());
          editor.session.setValue(JSON.stringify(parsed, null, 2));
          setFeedback("JSON formatted successfully.", "success");
        } catch (error) {
          setFeedback(`Unable to format JSON: ${error.message}`, "danger");
        }
      });

      document.getElementById("validate-json")?.addEventListener("click", () => {
        try {
          const parsed = JSON.parse(editor.getValue());
          if (!parsed || typeof parsed !== "object") {
            throw new Error("Scenario must be a JSON object");
          }
          if (!parsed.id && !(parsed.metadata && parsed.metadata.id)) {
            throw new Error("Provide an 'id' at the root or inside metadata.id");
          }
          if (!Array.isArray(parsed.steps)) {
            throw new Error("The 'steps' field must be an array");
          }
          setFeedback("JSON is syntactically valid and contains required fields.", "success");
        } catch (error) {
          setFeedback(`Invalid JSON: ${error.message}`, "danger");
        }
      });

      form.addEventListener("submit", () => {
        textarea.value = editor.getValue();
      });
    })();
  </script>
{% endblock %}
